{% extends "template.html" %}


{% block "content" %}

<h3>Events</h3>

<div class="col-lg-12">
    <div class="card">
        <div class="card-body">

            <h4>Event query
                <small>(must be of the same type)</small>
            </h4>

            <div class="panel panel-default">
                <div class="panel-heading" style="padding: 10px;">
                    Example query <a href="#" class="text-success pull-right" onclick="$('#sample-queries').toggle()">Show</a>
                </div>
                <div class="panel-body" id="sample-queries" hidden>
                    <ul>
                        <li><p>Example query for events from the last 24h from the event category
                            Category1:</p>
                            <code>select "Category1" where __timestamp__ >= 24h</code></li>
                        <li><p>Example query for events from the last 15 minutes from the event category
                            events_category_01:</p>
                            <code>select "events_category_01" where __timestamp__ >= 15m</code>
                            (note that 15m means 15 minutes, 24h means 24 hours)
                        </li>
                        <li><p>Example query for events from the category relevant_events from the last 10 minutes with
                            the field "count" equal to 10</p>
                            <code>select "relevant_events" where __timestamp__ >= 10m and values__count=10</code></li>
                        <li>p>Examplq query for events from the category relevant_events from the last hour with the
                            fields
                            field_1 equal to "hello" and field_2 greater or equal than 0</p>
                            <code>select "relevant_events" where __timestamp__ >= 1h and values__field_1="hello" and
                                values__field_2>=0</code></li>
                    </ul>

                    <p class="text-danger"><i class="glyphicon glyphicon-alert"></i> Check the documentation for more
                        info.</p>

                </div>
            </div>
            <div class="form-group">
                <label for="query" class="control-label">Query</label>

                <div class="input-group">
                    <input type="text" class="form-control" id="query" style="font-family: consolas;">

                    <div class="input-group-btn">
                        <button class="btn btn-success" id="run-query">Run query</button>
                    </div>
                </div>
            </div>

            <div class="alert alert-danger" id="query-error" hidden>An error occured: <span id="query-error-msg"></span>
            </div>

            <div id="table-area"></div>

        </div>
    </div>
</div>

<script>
    $("#run-query").on('click', function (event) {
        event.preventDefault();

        $("#table-area").empty();
        $("#query-error").hide();

        var getEventFields = function (data) {
            if (!data.length) {
                return []
            }
            var values = data[0].values;
            var keys = [];
            for (name in values) {
                if (!values.hasOwnProperty(name)) {
                    continue;
                }
                keys.push(name)
            }
            return keys
        };

        var getColumnDefinitions = function (fieldNames) {
            var columns = [];
            console.log(fieldNames);
            for (var i = 0; i < fieldNames.length; i++) {
                columns.push({data: "values." + fieldNames[i], title: fieldNames[i]});
                console.log(fieldNames[i]);
            }
            columns.push({data: "source", title: "Source"});
            columns.push({data: "timestamp", title: "Timestamp"});
            return columns
        };

        pymicroserviceMethodCall({
            method: 'query_events',
            params: {
                query: $("#query").val()
            },
            onSuccess: function (data) {
                if (data.error) {
                    $("#query-error").show();
                    $("#query-error-msg").text(JSON.stringify(data.error));
                }
                else {
                    $("#table-area").append($("<table id='data-table' class='table'></table>"));

                    var eventFields = getEventFields(data.result);
                    var columns = getColumnDefinitions(eventFields);

                    $("#data-table").dataTable({
                        data: data.result,
                        columns: columns
                    });
                }
            }
        })

    })
</script>

{% end %}

